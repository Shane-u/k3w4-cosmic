# 苍穹开发必备 100 个小知识


## 一、页面

### 1. 表单页面取值

#### ( 1 ) 获取简单字段的值

###### 问题 1 ：获取办公用品登记单的备注字段（文本字段）的值？

###### 参考答案：

数据模型IDataModel中存储了当前页面的数据包，对于文本类型、整数、时间字段等简
单类型字段，可以直接通过IDataModel的get方法直接获取字段值，值的返回类型有
String、Date、BigDecimal等。
IDataModelmodel=this.getModel();
Stringremark=(String)model.getValue("文本字段标识");
问题 2 ：获取单据体数量字段的值？
参考答案：
取单据体中的字段值需要指定行数，下标从 0 开始，如获取第一行数量字段的值：
BigDecimalqty=this.getModel().getValue("数量字段标识", 0 )


#### ( 2 ) 获取基础资料的属性值

###### 问题：如何获取创建人的生日？

###### 参考答案：

###### 创建人是基础资料字段，像创建人、修改人、用户字段本质都是基础资料字段，只是关联的

基础资料类型已预置人员【bos_user】。对于基础资料，通过this.getModel().getValue("
基础资料字段标识")拿到是一个对象 DynamicObject ，并且默认取出来的
DynamicObject数据中只包含基础资料的id、name、number属性值。
DynamicObjectcreatorDObj=(DynamicObject)this.getModel().getValue("creator");

所以直接this.getModel().getValue（）默认无法获取到基础资料除id,name、number
外的属性值，需要通过以下两种方式获取。
方式 1 ：在表单设计器中引用人员的“生日”属性，然后再通过以下代码可以取到基础资料
某个属性。

```
DynamicObjectcreatorDObj=(DynamicObject)this.getModel().getValue("creator");
Stringbirthday=creatorDObj.getString("birthday");
```

方式 2 ：先拿到基础资料的id，再通过orm接口去查基础资料的某个属性值。
//获取当前页面创建人字段的数据对象
DynamicObjectcreatorDObj=(DynamicObject)this.getModel().getValue("creator");
ObjectpkValue=creatorDObj.getPkValue();//拿主键即id
QFilteridQFilter=newQFilter("id",QCP.equals,pkValue);//构造过滤条件
DynamicObjectqueryRuselt=
QueryServiceHelper.queryOne("bos_user","birthday",newQFilter[]{idQFilter});//查
询数据库
Stringbirthday=queryRuselt.getString("birthday");//拿属性的值

#### ( 3 ) 获取单据体某个字段或行对象

###### 问题 1 ：如何获取单据体某行某个字段的值？

答：this.getModel().getValue("kded_textfield", 0 );// 0 代表第一行
问题 2 ：如何获取单据体中各行的数据？
参考答案：
单据体中的数据是多行数据的集合，每行数据都是一个DynamicObject 数据包，每行数
据又包含多个字段（简单值、复杂值）值。
方式 1 ：
//获取当前页面的数据包
DynamicObjectdataEntity=this.getModel().getDataEntity(true);
//获取单据体数据的集合
DynamicObjectCollection goodsEntities=dataEntity.getDynamicObjectCollection("
单据体标识");
for(DynamicObjectentryObj:goodsEntities){
//获取某行数据的id
Objectpk=entryObj.getPkValue();
//获取某行的某个字段的值
Objectobject=entryObj.get("字段标识");
}
方式 2 ：
DynamicObjectCollectionentryRows=this.getModel().getEntryEntity("单据体标识");


#### ( 4 ) 获取子单据体某个字段或行

###### 问题 1 ：如何获取子单据体某行某个字段的值？

###### 参考答案：

this.getModel().getValue("kded_textfield", 0 , 0 );
//第一个整数代表子单据体行号，第二个整数代表父单据体行号
问题 2 ：如何获取子单据体中各行的数据？
参考答案：
子单据体中的数据也是是多行数据的集合，并且是挂在单据体行里的，所以需要先得到单据
体的行数据对象，再从单据体行数据对象获取子单据数据行集合。
//获取当前页面的数据包
DynamicObjectdataEntity=this.getModel().getDataEntity(true);
//先获取单据体数据的集合
DynamicObjectCollection goodsEntities=dataEntity.getDynamicObjectCollection("
单据体标识");
for(DynamicObjectentryObj:goodsEntities){
//再获取子单据体行某行数据的id
DynamicObjectCollectioncols=entryObj.getDynamicObjectCollection("子单据体
标识");
for(DynamicObjectcol:cols){
col.get("字段标识");//获取子单据体字段的值
}
}

#### ( 5 ) 获取富文本控件的值

###### 问题：如何获取富文本控件的值？

参考答案：富文本是通用控件，通用控件不能存储数据，所以不能通过model来取值，富
文本的控件模型提供了相应的接口。
RichTextEditoredit=this.getView().getControl("富文本控件标识");
Stringtext=edit.getText();
因此需要保存时把富文本的数据保存到一个大文本字段上，打开保存后的单据时，将该大文
本的值绑定到富文本控件上。
//在保存单据时，将富文本控件的内容保存到大文本字段
publicvoidbeforeDoOperation(BeforeDoOperationEventArgse){


FormOperateoperate= (FormOperate)e.getSource();
Stringkey=operate.getOperateKey();
if(key.equalsIgnoreCase("save")){
RichTextEditoredit=this.getView().getControl("富文本控件标识");
Stringtext=edit.getText();
this.getModel().setValue("大文本字段标识",text);//赋值到大文本字段上
}
//在打开单据时，将大文本字段的值显示到富文本控件
publicvoidafterBindData(EventObjecte){
super.afterBindData(e);
RichTextEditoredit=this.getView().getControl("富文本控件标识");
Stringtext=edit.setText((String)this.getModel().getValue("大文本字段标识"));
}
注意事项：能够通过model去获取值的字段，必须在表有对应的表字段，比如富文本、基
础资料属性这类字段，是没有表字段的，自然不能通过model去取值及赋值。

#### ( 6 ) 获取多选基础资料的值

多选基础资料字段配置的时候是要写表名的，通过model拿到的就是该表某些数据的集合，
遍历集合才能拿到实际选择的基础资料数据对象。
DynamicObjectCollectionmultiCols=(DynamicObjectCollection)
this.getModel().getValue("kded_mulbasedatafield");
for(DynamicObjectcol:multiCols){
//获取选择的基础资料数据对象
DynamicObjectbaseData=(DynamicObject)col.get("fbasedataid");
}

### 2. 表单页面赋值

#### ( 1 ) 给简单字段赋值

###### 问题：新增单据时，如何自动给办公用品登记单备注字段（文本）设置默认值？

参考答案：简单字段的赋值，直接通过当前页面的数据模型IDataModel 赋值给字段赋值。


```
@Override
publicvoidafterCreateNewData(EventObjecte){
IDataModelmodel=this.getModel();
model.setValue("kded_remark","我的备注数据");
}
```
#### ( 2 ) 给基础资料字段赋值

###### 问题：如何给办公用品登记单的登记人字段赋值？

###### 参考答案：因为登记人的是“用户”类型字段，而用户字段又是特殊的基础资料字段。

所以给基础资料赋值必须用基础资料的id或者基础资料的DynamicObject。
@Override
publicvoidafterCreateNewData(EventObjecte){
longcurrentUserId=UserServiceHelper.getCurrentUserId();
//方式 1 ：通过id赋值-推荐
this.getModel().setValue("kded_registrant",currentUserId);
//方式 2 ：通过对象赋值
DynamicObjectuser=BusinessDataServiceHelper.loadSingle(currentUserId,
"bos_user");
this.getModel().setValue("kded_registrant",user);
}
注意：不能使用QueryServiceHelper.queryOne查到的平铺对象赋值给基础资料字段。

#### ( 3 ) 给单据体的字段赋值

###### 问题：如何给单据体某个字段赋值？

###### 参考答案：

方式 1 ：如果是知道行号index，且只需要给这行的字段赋值，则参考：
this.getModel().setValue("字段标识","字段值",index);
方式 2 ：需要给每行赋值，则需遍历单据体进行赋值：
DynamicObjectCollectionentryRows=this.getModel().getEntryEntity("单据体标识");
for(DynamicObjectentryObj:entryRows){
//修改某行的某个字段的值
entryObj.set("kded_textfield","测试");}
this.getView().updateView("entryentity");


###### }

注意点：方式 2 如果在afterCreateNewData事件则不需要updateView,否则需要代码刷
新前台才会显示。

#### ( 4 ) 给单据体新建行

###### 问题：如何给办公用品登记单的单据体添加一行数据？

方式 1 ：单据体虽然是集合，但是数据模型IModel提供了直接增加行的接口，需要知道要
增加的行数row。
int[]newEntryRow=this.getModel().batchCreateNewEntryRow("单据体标识",row);
for(intindex:newEntryRow){
this.getModel().setValue("单据体某个字段标识",值,index);
}

方式 2 ：给单据体创建行对象，再调用IModel增加行的接口。
DynamicObjectentry=
ORM.create().newDynamicObject(this.getModel().getEntryEntity("单据体标识
").getDynamicObjectType());
entry.set("kded_textfield 1 "," 44 ");
entry.set("kded_amountfield"," 10 ");
introwindex=this.getModel().createNewEntryRow("单据体标识",entry);
注意：如果单据体字段有设置默认值，此方式默认值会覆盖代码设置的值。

###### 方式 3 ：通过数据包给单据体直接新增行对象。

DynamicObjectCollectionentryentityCols=
this.getModel().getDataEntity(true).getDynamicObjectCollection("entryentity");
DynamicObjectentryCol=entryentityCols.addNew();
entryCol.set("kded_textfield","方式 4 ");
this.getView().updateView("entryentity");
获取单据体数据包，在数据包新增行对象，是需要代码调用updateView才会将新内容显
示到界面上。

#### ( 5 ) 给子单据体新建一行

###### 问题：如何给子单据体添加一行数据？


###### 参考答案：

###### //先设置父单据体选中行

```
this.getModel().setEntryCurrentRowIndex("entryentity", 0 );
//创建子单据体行-方式 1
int[]ints=this.getModel().batchCreateNewEntryRow("kded_subentryentity", 1 );
for(intindex:ints){
this.getModel().setValue("kded_textfield 2 ","文本值",index);
}
```
###### //创建子单据体行-方式 2

```
DynamicObjectsubEntry=
ORM.create().newDynamicObject(this.getModel().getEntryEntity("kded_subentryentit
y").getDynamicObjectType());
subEntry.set("kded_textfield 2 ","行对象");
introwindex=this.getModel().createNewEntryRow("kded_subentryentity",
subEntry);
```
#### ( 6 ) 给富文本控件赋值

###### 问题：如何给富文本控件赋值？

参考答案：富文本是通用控件，不能像实体字段一样直接用数据模型this.getmodel赋值，
需要通过富文本控件模型RichTextEditor提供的方法setText设置值。
RichTextEditoredit=this.getView().getControl("richtexteditorap");
edit.setText("要设置的内容");

#### ( 7 ) 给多选基础资料赋值

###### 参考答案：

【https://vip.kingdee.com/article/ 198799132897594368 ?productLineId= 29 】


### 3. 列表页面赋值

#### ( 1 ) 单据列表

###### 问题：如何在列表中动态修改或更新当前流程处理人字段？

###### 参考答案：列表是用来显示单据存储在数据库中的数据的，如果要在列表显示的时候，修改

列表数据，可以在列表插件中重写beforeCreateListDataProvider方法，构建自定义的列
表取数器，实现自主取数，具体参考：
【https://vip.kingdee.com/article/ 306390194805169920 ?productLineId= 29 】

### 4. 数据复制

#### ( 1 ) 如何复制单据数据

###### 问题：办公物品登记单添加添加一个备份功能，保存时，如果数据库中已存在该表单数据，

则生成该条单据的副本数据，要求业务数据和原来保持一致（id这种唯一性数据不做要求），
并把备注字段赋值："备份数据"。
参考答案：首先，要找到在哪个事件中去备份数据。要求保存时，要先查询数据库中是否有
数据，那就是该次保存还未正式保存到数据库中的时候去处理。即在操作插件
beginOperationTransaction事件中同步备份数据。
publicclassSrSubmitOpPluginextendsAbstractOperationServicePlugIn{
@Override
publicvoidonPreparePropertys(PreparePropertysEventArgse){
super.onPreparePropertys(e);
e.getFieldKeys().add("kded_srstatus");
}
@Override
publicvoidbeginOperationTransaction(BeginOperationTransactionArgse){
super.beginOperationTransaction(e);
DynamicObject[]dataEntities=e.getDataEntities();
for(DynamicObjectdata:dataEntities){
//单据标识
StringentityNumber=data.getDataEntityType().getName();


//data是保存前且校验通过的数据包，此处备份数据
ObjectpkValue=obj.getPkValue()
booleanexists=QueryServiceHelper.exists(entityNumber,pkValue);
if(exists){
//如下复制数据方案 1 或者方案 2
)else{
}
}
}
}
数据复制有两种方案：
方案 1 ：创建空数据包，并逐一赋值-不推荐，后续表单增加字段，需要不断迭代代码。
//创建空的数据包
DynamicObjectnewDynamicObject=
BusinessDataServiceHelper.newDynamicObject(entityNumber);
newDynamicObject.set("单据头字段标识a",data.get("单据头字段标识a"));
newDynamicObject.set("备注字段标识","备份数据");
//单据体数据行
DynamicObjectCollectionnewCol=
newDynamicObject.getDynamicObjectCollection("单据体标识");
DynamicObjectCollectionoldCol=data.getDynamicObjectCollection("单据体标 识
");
//复制当前分录数据到新增数据包的新增分录行上
for(DynamicObjectoldEntry:oldCol){
//创建一个空的分录行
DynamicObjectnewEntry=new
DynamicObject(newCol.getDynamicObjectType());
newEntry.set("单据体字段标识x",oldEntry.get("单据体字段标识x"));
//新增数据行添加到单据体上
newCol.add(newEntry);
}
//保存数据
SaveServiceHelper.saveOperate(entityNumber,newDynamicObject[]
{newDynamicObject})
方案 2 ：直接克隆整个数据包-增加字段无需迭代代码，推荐。
DynamicObjectnewData=(DynamicObject)new CloneUtils(false,true).clone(data);


```
newData.set("备注字段标识","备份数据");
//保存数据
SaveServiceHelper.saveOperate(entityNumber,newDynamicObject[]{newData})
```
### 5. 页面参数

#### ( 1 )如何判断界面是否新增界面？...............................................................................

###### 问题：办公用品登记单打开时，如果是新增页面，则弹出提示“您正在新增办公用品登记

###### 单”；如果是编辑页面，则提示”您正在编辑一个办公用品登记单“。

###### 参考答案：

①首先确认要重写的事件，要在“新增”和“编辑”状态下都会执行。而弹出提示是view
的行为，所以一般建议在afterBindData事件中处理。
②每个界面视图中，都保存了相关界面的参数，包括但不局限于：页面pageid，表单标识、
表单运行插件、父页面传过来的自定义参数等，例如当前页面是新增状态还是编辑状态，可
以根据单据页面的界面参数FormShowParameter中的getStatus方法获取到。
BillShowParameterbsp=(BillShowParameter)this.getView().getFormShowParameter();
if(bsp.getStatus()==OperationStatus.ADDNEW){
this.getView().showTipNotification("您正在新增办公用品登记单")；
}
if(bsp.getStatus()==OperationStatus.EDIT){
this.getView().showTipNotification("您正在编辑一个办公用品登记单")；
}

### 6 .视图模型VIEW..................................................................................................................

#### ( 1 )取消打开页面...........................................................................................................

###### 问题：如何控制办公用品登记单在周日的的时候不能新增单据？

参考答案：在表单显示前判断newDate()判断一下如果是周日，然后在preOpenForm事
件中取消页面的打开。
@Override
publicvoidpreOpenForm(PreOpenFormEventArgse){
e.setCancel(true);


```
e.setCancelMessage("对不起，周日不能制单！");
}
```
#### ( 2 )设置控件的锁定性...................................................................................................

##### 第一种：锁定单据头字段......................................................................................

###### 问题 1 ：办公用品登记单的总金额自动计算得出的，所以始终是锁定状态。

###### 参考答案：

###### 方式 1 ：表单设计器上设置”新增锁定、修改锁定、提交锁定、审核锁定"。

###### 方式 2 ：通过如下代码设置锁定性。

@Override
publicvoidafterBindData(EventObjecte){
super.afterBindData(e);
this.getView().setEnable(false,"字段标识");
}
说明:其他场景下，影响锁定性的因素还有单据类型、界面规则、布局等。

##### 第二种：锁定单据体或单据体字段......................................................................

###### 问题 1 ：如何锁定单据体某几行？

###### 参考答案：

###### //锁定单据体某几行，所有字段都锁定

EntryGridentryGrid=this.getView().getControl("entryentity");
entryGrid.setRowLock(true,newint[]{ 0 , 1 });
问题 2 ：如何锁定单据体某一行某一列？
参考答案：
//锁定单据体某行某列
this.getView().setEnable(false, 2 ,"kded_dealdesc");
问题 3 ：如何锁定某一列？
参考答案：没有锁定整列的接口，需遍历单据体行锁定
introwCount=this.getModel().getEntryRowCount("entryentity");
for(inti= 0 ,i<rowCount,i++){
this.getView().setEnable(false,i,"kded_dealdesc");
}
问题 4 ：如何锁定整个单据体？
参考答案：


```
this.getView().setEnable(false,"entryentity");
```
#### ( 3 )设置控件可见性.......................................................................................................

###### 问题：如何设置单据在审核状态下审核人字段可见？

###### 参考答案：

###### 方式 1 ：字段的可见性配置勾选“审核可见”。

方式 2 ：同样在afterBindData事件中先判断单据状态是审核状态时，再设置审核人字段可
见：this.getView().setVisible(true,"字段标识");
补充:其他场景下，影响可见性的因素还包括界面规则、单据类型、布局等。

#### ( 4 )设置字段必录性.......................................................................................................

###### 问题 1 ：如何通过代码设置单据头字段必录？

###### 参考答案：

TextEdittextField=(TextEdit)this.getView().getControl("kded_textfield 1 ");
textField.setMustInput(true);
问题 2 ：如何通过代码设置单据体字段必录？
参考答案：
//设置单据体字段必录，kded_dealdesc是单据体一个文本字段的标识
TextEdittextField 1 =(TextEdit)this.getView().getControl("kded_dealdesc");
textField 1 .setMustInput(true);
TextPropit 2 =(TextProp)textField 1 .getProperty();
it 2 .setMustInput(true);

#### ( 5 )设置单据体选中行...................................................................................................

###### 问题：单据体有数据时，如何设置单据体默认选中第一行数据？

###### 参考答案：苍穹平台的每个控件都有定义好的控件模型，通过控件模型的接口可以间接改变

###### 界面显示的内容；设置单据体默认选中行，首先想到这是单据体控件的独有控件属性，所以

先获取单据体控件模型EntryGrid，查找EntryGrid有没有提供对应的方法，显然EntryGrid
有设置选中行的设置方法selectRows。
//数据模型中获取单据体的数据行数


```
intentryRowCount=this.getModel().getEntryRowCount("sunp_entryentity");
if(entryRowCount!= 0 ){
//获取单据体控件模型
EntryGrideg=this.getView().getControl("sunp_entryentity");
//通过单据体控件模型的方法实现选中行功能
eg.selectRows( 0 );
}
```
#### ( 6 )执行页面的按钮点击事件.......................................................................................

###### 问题：如何通过代码触发工具栏或按钮的点击逻辑？

###### 参考答案：先获取对应的控件模型，控件模型提供了点击方法。

```
//tbmain是工具栏标识，bar_save是工具栏项标识，save是工具栏绑定的操作
Toolbartoolbar=this.getView().getControl("tbmain");
toolbar.itemClick("bar_save","save");
//触发按钮，kded_btsave是按钮标识
Buttonbutton=this.getView().getControl("kded_btsave");
button.click();
```
#### ( 7 )执行操作...................................................................................................................

###### 问题：如何通过代码触发某个操作？

###### 参考答案：界面模型提供了相关接口。

```
this.getView().invokeOperation("save");//save是操作标识
```
#### ( 8 )刷新数据...................................................................................................................

###### 问题 1 ：通过插件给单据头的字段赋值，发现值没显示出来时，应该如何刷新字段的值？

###### 参考答案：

this.getView().updateView("字段标识");
//或者
this.getView().updateView();
问题 2 ：通过插件给单据体的字段赋值，发现值没显示出来时，应该如何刷新单据体字段的
值？
参考答案：


this.getView().updateView("单据体字段",所在行号);
//如果刷新很多单据体字段，可以选择刷新整个单据体
this.getView().updateView("单据体标识");
//或者
this.getView().updateView();
问题 3 ：在用户打开查看单据的某条数据时，并在插件中通过
BusinessDataServiceHelper.loadSingle查数据库中对应的数据进行修改,并通过
SaveServiceHelper.update更新数据到数据库，那么用户此时该如何刷新修改的数据到当
前页面
参考答案：
//或者调用表单的“刷新”操作
this.getView().invokeOperation("refresh");
推荐：由于刷新是有性能消耗的，updateView建议指定刷新字段或刷新单据体的标识，
尽量不要进行全局刷新-this.getView().updateView()。

#### ( 9 )页面关闭...................................................................................................................

###### 问题 1 ：在修改了数据之后，没有保存就退出，会提示如下图。如何取消该校验？

参考答案：提示是在页面关闭时的校验，那么可以在页面关闭前事件beforeClosed中，通
过修改事件参数取消校验。
@Override


publicvoidbeforeClosed(BeforeClosedEvente){
super.beforeClosed(e);
e.setCheckDataChange(false);
}
问题 2 ：如何通过代码关闭页面。
参考答案：
this.getView().close();
//或者
this.getView().invokeOperation("close");

#### ( 10 ) 页面弹出提示信息.................................................................................................

###### 问题 1 ：如何通过代码弹出提示信息？

###### 参考答案：

this.getView.showMessage("提示信息");
更多提示方式见：
https://vip.kingdee.com/school/ 238714716992919296 ?topicId= 239383452913417
728 &stageId= 239383671570873856 &pathId= 239410657773565696 &productLine
Id= 29

#### ( 11 ) 修改控件名称.........................................................................................................

###### 问题 1 ：如何通过代码修改字段控件的名称？

参考答案：TextEdit的父类FieldEdit提供setCaption接口修改控件名称。如：
TextEdittextField=(TextEdit)this.getView().getControl("kded_textfield 1 ");
textField.setCaption(newLocaleString("sss"));
注意：当通过该方式修改字段标题后，修改该字段退出界面会提示已有XXX字段修改，是
否继续退出，这里还是显示修改前的字段名称，需要通过以下代码修改主数据模型对应属性
的标题：
//对应修改元数据对应属性的标题
Map<String,IDataEntityProperty>allFields
=this.getModel().getDataEntityType().getAllFields();
IDataEntityPropertykded_textfield 1 =allFields.get("kded_textfield 1 ");
kded_textfield 1 .getDisplayName().setLocaleValue("sss");


###### 问题 2 ：如何通过代码修改非字段类型的控件名称，比如按钮、高级面板等？

参考答案：使用动态更新元数据属性的接口updateControlMetadata。
Map<String,Object>text=newHashMap<>();
Map<String,Object>text 1 =newHashMap<>();
text.put("zh_CN","test");
text 1 .put("text",text);
this.getView().updateControlMetadata("控件标识",text 1 );

#### ( 12 ) 页面缓存.................................................................................................................

###### 问题：如何使用页面缓存？

###### 参考答案：

```
this.getView().getPageCache().put("isLeaf","true");
StringisLeaf=this.getView().getPageCache().get("isLeaf");
```
#### ( 13 ) 获取当前页面的元数据信息.................................................................................

###### 问题：如何获取运行期表单及表单所有控件信息？

###### 参考答案：

元数据相关的servicehelper：MetadataServiceHelper、AppMetaServiceHelper、
ConvertMetaServiceHelper、LocaleMetadataServiceHelper等，优先使用这些。（注
意不要用到非平台的）
//根据表单编码获取表单id
Stringid=MetadataDao.getIdByNumber("kdec_cehsi",MetaCategory.Form);
//获取表单元数据
FormMetadataformMeta=(FormMetadata)MetadataDao.readRuntimeMeta(id,Meta
Category.Form);
//遍历获取所有控件集合
for(ControlAp<?>item:formMeta.getItems()){
//可见性
Stringvisible=item.getVisible();
//控件名称
Stringname=item.getName().getLocaleValue();
//控件编码
Stringkey=item.getKey();


###### }

## 二、前后端交互..............................................................................................................................

### 1 .用户输入.............................................................................................................................

#### ( 1 )数据联动...................................................................................................................

###### 问题：办公用品登记单选择物品后，如何自动给物品分类赋值？

###### 参考答案：

###### 方式 1 ：使用基础资料属性字段，然后绑定物品字段，显示属性选择物品分类名称。

###### 方式 2 ：通过业务规则配置【计算定义公式的值并填写到指定列 】服务实现。

方式 3 ：在值更新事件propertyChanged中获取变更的物品值，并给“物品分类”字段赋
值。
@Override
publicvoidpropertyChanged(PropertyChangedArgse){
if(e.getProperty().getName().equals("物品字段标识")){
ChangeDatachangeData=e.getChangeSet()[ 0 ];
//变更后的数据
DynamicObjectnewValue=(DynamicObject)changeData.getNewValue();
DynamicObject
goodObj=BusinessDataServiceHelper.loadSingle(newValue.getPkValue(),"物
品的标识","物品里分类字段标识");
DynamicObjectgroupObj=goodObj.getDynamicObject("物品里分类字段标
识");
this.getModel().setValue("物品分类字段标识",groupObj);
}
}

#### ( 2 )通过代码赋值后不想触发值更新事件...................................................................

方式 1 ：在afterCreatedNewData事件赋值，是不会触发值更新事件的。
方式 2 ：在其他事件赋值时，使用以下方式赋值。


```
this.getModel().beginInit();
this.getModel().setValue("字段标识","字段值");
this.getModel().endInit();
```
### 2 .用户点击.............................................................................................................................

苍穹平台表单页面的点击及触发原理也是基于Java委托事件处理机制，关键对象包括如下：
EventSource(事件源)：事件发生的场所，通常就是各个组件，例如按钮、窗口、菜单、工
具栏（在苍穹上对应Toolbar控件）等。
Event(事件)：事件封装了GUI组件上发生的特定事情（用户动作、行为）。
EventListener(事件监听器)：注册于某个事件源上，用于响应特定的事件。
在苍穹平台中，所有标准控件的事件源（Button.class,Toolbal.class,EntryGrid.class等）
已经定义好了，用户点击苍穹表单页面某个地方时，是否会触发特定的响应方法（click、
itemClick、billListHyperLinkClick等），需要满足以下两个条件。
①事件的产生：以用户点击工具栏新增按钮为例，表单微服务根据前端发送的指令最终调用
事件源（Toolbar控件模型）创建了两个事件（BeforeItemClickEvent、ItemClickEvent）。


②在表单插件的 registerListener 方法中注册 ToolBar 事件源的事件监听器
（ClickListener、ItemClickListener）并重写监听器对应的响应事件方法click、itemClick。

由于只产生了BeforeItemClickEvent、ItemClickEvent这两个事件，没有ClickEvent事
件，所以只会响应itemClick方法。

###### 以上举例介绍了下事件的处理机制，下面列举几种常见的干预用户点击事件的处理方法。

#### ( 1 )文本字段/按钮点击.................................................................................................

###### 问题：如何在点击办公用品登记单的备注（文本字段）时，提示“备注信息不允许修改”？

参考答案：文本字段设置属性“编辑风格”为”按钮点击编辑“时，在register事件中注
册监听。
@Override
publicvoidregisterListener(EventObjecte){
//TODOAuto-generatedmethodstub
super.registerListener(e);
TextEdittEdit=this.getView().getControl("备注字段标识");
tEdit.addClickListener(this);
}

并重写Click方法。
@Override
publicvoidclick(EventObjectevt){
//TODOAuto-generatedmethodstub


```
super.click(evt);
Controlsource=(Control)evt.getSource();
if("备注字段标识".equals(source.getKey())){
//TODO 在此添加业务逻辑
}
}
```
#### ( 2 )工具栏按钮点击.......................................................................................................

###### 问题：点击办公用品登记单的提交按钮时，弹出确认提示框是否确认提交。

###### 参考答案：确认是否提交，所以必须在提交按钮执行前处理，点击确认提交后再继续执行提

###### 交操作。

```
@Override
publicvoidregisterListener(EventObjecte){
super.registerListener(e);
//监听工具栏按钮点击事件
this.addItemClickListeners(KEY_TOOlBAR);
}
@Override
publicvoidbeforeItemClick(BeforeItemClickEventevt){
//工具栏上的所有按钮的点击都会激活itemClick和beforeItemClick方法，需
//要开发人员实现不同按钮的逻辑
if(evt.getItemKey().equals("bar_submit")){
evt.setCancel(true);
ConfirmCallBackListenerconfirmCallBackListener=new
ConfirmCallBackListener("submitconfirm",this);
//设置页面确认框，参数为：标题，选项框类型，回调监听
this.getView().showConfirm("您确认提交该办公用品登记单吗？",
MessageBoxOptions.YesNoCancel,confirmCallBackListener);
}
super.beforeItemClick(evt);
}
@Override
publicvoidconfirmCallBack(MessageBoxClosedEventmessageBoxClosedEvent){
super.confirmCallBack(messageBoxClosedEvent);
```

###### //判断是否是对应确认框的点击回调事件

```
if(("submitconfirm").equals(messageBoxClosedEvent.getCallBackId())){
if(MessageBoxResult.Yes.equals(messageBoxClosedEvent.getResult())){
//如果点击确认按钮，则调用提交操作
this.getView().invokeOperation("submit");
}elseif(MessageBoxResult.No.equals(messageBoxClosedEvent.getResult())){
```
```
}elseif
(MessageBoxResult.Cancel.equals(messageBoxClosedEvent.getResult())){
// 点击取消的相关处理逻辑。。。。
}
}
```
#### ( 3 )基础资料点击...........................................................................................................

###### 问题：办公用品登记单先选择物品分类，然后在选择物品时，只显示已选物品分类的物品。

###### 参考答案：在选择物品前，添加过滤条件。需要监听物品基础资料的选择前事件。

@Override
publicvoidregisterListener(EventObjecte){
super.registerListener(e);
BasedataEditbde=this.getView().getControl("物品字段字段标识");
bde.addBeforeF 7 SelectListener(this)
}
并实现BeforeF 7 SelectListener接口及重写beforeF 7 Select方法。最后在beforeF 7 Select
方法中设置过滤条件，参考开发案例
【https://vip.kingdee.com/article/ 198077267325441280 ?productLineId= 29 】。

#### ( 4 )单据体点击...............................................................................................................

##### ①单据体单元格点击..............................................................................................

问题 1 ：单据体上添加了个文本字段，数据存储了某个附件url的下载地址，锁定状态；点
击某个url时，下载该文件。
参考答案：先在registerListener事件注册单据体单元格监听器。


```
@Override
publicvoidregisterListener(EventObjecte){
super.registerListener(e);
EntryGrideg=this.getView().getControl("sunp_entryentity");
eg.addCellClickListener(this);
}
```
然后实现CellClickListener接口及cellClick方法
@Override
publicvoidcellClick(CellClickEventarg 0 ){
//获取点击单元格的字段及值
StringfieldKey=arg 0 .getFieldKey();
if(fieldKey.equals("字段标识")){
Stringurl=(String)this.getModel().getValue(fieldKey,arg 0 .getRow());
this.getView().openUrl(url);
//或者this.getView().download(url);
}
System.out.println("xx");
}

##### ②单据体行点击......................................................................................................

###### 问题 2 ：在办公用品登记单的单据体的工具栏上添加一个查看库存按钮，查看选择行的物品

###### 的库存，在选择行时，校验是否物品为空。

###### 参考答案：单据体选择行不需要考虑点击的字段，主要鼠标点击时在单据体某行上时即可。

###### 所以注册行点击监听器。

@Override
publicvoidregisterListener(EventObjecte){
super.registerListener(e);
EntryGrideg=this.getView().getControl("sunp_entryentity");
eg.addRowClickListener(this);
}
并实现接口RowClickEventListener及实现entryRowClick方法，在entryRowClick方法
中获取物品值是否为空，为空则取消选择行。


##### ③用代码选中单据体行..........................................................................................

```
this.getModel().setEntryCurrentRowIndex("单据体标识",rowIndex);
```
##### ④ 获取单据体当前选中行....................................................................................

###### //方式 1 - 获取当前选中行

```
this.getModel().getEntryCurrentRowIndex("单据体标识");//只能获取当前选中行
//方式 2 - 获取所有选中行
//通过单据体控件获取选中行
EntryGridentryGrid=this.getView().getControl("sunp_entryentity");
int[]selectRows=entryGrid.getSelectRows();
```
#### ( 5 )单据列表超链接点击...............................................................................................

###### 问题：办公用品登记单的单据列表点击某个超链接时，取消原有的弹窗逻辑，自定义弹出该

###### 表单。

###### 参考答案：

###### /**

###### *用户点击超链接单元格时，触发此事件

###### */

```
@Override
publicvoidbillListHyperLinkClick(HyperLinkClickArgsargs){
if (StringUtils.equals(" 超 链 接 所 在 列 的 字 段 标 识 ",
args.getHyperLinkClickEvent().getFieldName())){
// 取消系统自动打开本单的处理
args.setCancel(true);
introwIndex=args.getRowIndex();//点击的行下标
BillListbl=this.getView().getControl("billlistap");
ListSelectedRowCollectioncurrentListAllRowCollection=
bl.getCurrentListAllRowCollection();
ListSelectedRow listSelectedRow =
currentListAllRowCollection.get(rowIndex);
//点击行数据
```

ObjectprimaryKeyValue=listSelectedRow.getPrimaryKeyValue();//主键值
StringformID=listSelectedRow.getFormID();
BillShowParameterbsp=newBillShowParameter();
bsp.setFormId(formID);
bsp.setPkId(primaryKeyValue);
bsp.getOpenStyle().setShowType(ShowType.Modal);
bsp.setStatus(OperationStatus.EDIT);
this.getView().showForm(showParameter);
}
}
点击单据列表时，同时会触发执行listRowClick方法。大家可能好奇为什么单据列表中点
击为什么不用注册监听器。这是因为标准的单据列表视图模型对象中注册了相关监听器：
kd.bos.mvc.list.AbstractListView.registerListener()。

#### ( 6 )列表获取当前选中行...............................................................................................

###### 方式 1 ：通过列表控件模型获取

BillListbilllistap=this.getView().getControl("billlistap");
ListSelectedRowCollectionselectedRows=billlistap.getSelectedRows();
方式 2 ：在列表插件实例自带接口
ListSelectedRowCollectionselectedRows 1 =this.getSelectedRows();

### 3 .父子页面交互.....................................................................................................................

###### 比如办公用品登记单点击物品新增申请，在新增申请表单点击确定后把物品名称给办公物品

###### 登记单的备注字段”。

#### ( 1 )代码弹出表单页面...................................................................................................

第一步：办公用品登记单插件的itemClick方法中弹出物品新增申请单。
@Override
publicvoiditemClick(ItemClickEventevt){
FormShowParameterfsp=newFormShowParameter();
fsp.setFormId("物品新增申请单");
fsp.getOpenStyle().setShowType(ShowType.Modal);


```
fsp.setCloseCallBack(newCloseCallBack(this,"show-kded_supaddnew"));//
this.getView().showForm(fsp);
super.itemClick(evt);
}
```
#### ( 2 )如何修改父页面的数据...........................................................................................

方案 1 ：直接在子页面的表单插件中拿到父页面的数据模型model进行赋值。
@Override
publicvoidclick(EventObjectevt){
if(evt.getSource()instanceofButton){
Buttonbt=(Button)evt.getSource();
Stringkey=bt.getKey();
if(key.equals("btnok")){
ObjectgoodName=this.getModel().getValue("物品名称字段标识");
IFormViewparentView=this.getView().getParentView();//父页面
IDataModelparentModel=parentView.getModel();
parentModel.setValue("sunp_textfield",goodName));//修改父页面数据
parentView.updateView();//刷新
//调用了其他表单的控制方法时，需调用以下方法将目标表单的控制指
//令发给前端
this.getView().sendFormAction(this.getView().getParentView());
this.getView().close();
}
}
super.click(evt);
}
方案 2 ：将子页面的字段值传给父页面，然后在父页面的表单插件的closedCallBack方法
中修改备注字段值。
新增物品申请单表单插件：
@Override
publicvoidclick(EventObjectevt){
if(evt.getSource()instanceofButton){
Buttonbt=(Button)evt.getSource();
Stringkey=bt.getKey();


if(key.equals("btnok")){//确定按钮或者是邮件通知按钮
ObjectgoodName=this.getModel().getValue("物品名称字段标识");/
this.getView().returnDataToParent(goodName);//返回数据给父页面
this.getView().close();
}
}
}
办公用品登记单插件：
@Override
publicvoidclosedCallBack(ClosedCallBackEventclosedCallBackEvent){
if(closedCallBackEvent.getActionId().equals("show-kded_supaddnew")){
ObjectreturnData=closedCallBackEvent.getReturnData();
this.getModel().setValue("sunp_textfield",returnData);
}
super.closedCallBack(closedCallBackEvent);
}
方案 3 ：将子页面的值放到父页面缓存，由父页面插件进行赋值处理。
新增物品申请单表单插件：
@Override
publicvoidclick(EventObjectevt){
if(evt.getSource()instanceofButton){
Buttonbt=(Button)evt.getSource();
Stringkey=bt.getKey();
if(key.equals("btnok")){//确定按钮或者是邮件通知按钮
ObjectgoodName=this.getModel().getValue("物品名称字段标识");/
//通过界面缓存传递值
this.getView().getParentView().getPageCache().put("name",goodName);
this.getView().close();
}
}
}
}
办公用品登记单插件：
@Override
publicvoidclosedCallBack(ClosedCallBackEventclosedCallBackEvent){
if(closedCallBackEvent.getActionId().equals("show-kded_supaddnew")){


```
this.getModel().setValue("sunp_textfield",this.getView().getPageCache().
get("name"));
}
super.closedCallBack(closedCallBackEvent);
}
```
### 4 .基础资料选择界面（F 7 ）................................................................................................

#### ( 1 )F 7 选择界面显示哪些字段......................................................................................

基本上F 7 选择界面都是统一的界面，普通基础资料用的是bos_listf 7 ，分组基础资料和树
形基础资料用的是bos_templatetreelistf 7 界面，部分基础资料，比如人员、组织、客户、
供应商等基础资料有自己的f 7 界面。
F 7 选择界面的字段由基础资料列表的字段决定，给列表增加字段，并且【可见性】选上F 7
界面可见。

#### ( 2 )F 7 选择界面显示未审核的数据..............................................................................

```
@Override
publicvoidbeforeF 7 Select(BeforeF 7 SelectEventbeforeF 7 SelectEvent){
```
```
if("kded_basedatafield".equals(beforeF 7 SelectEvent.getProperty().getName())){
ListShowParameterlistShowParameter=(ListShowParameter)
beforeF 7 SelectEvent.getFormShowParameter();
listShowParameter.setShowApproved(false);
}
```

###### ｝

#### ( 3 )F 7 选择界面展示已选择的数据，开启多选等......................................................

```
publicvoidbeforeF 7 Select(BeforeF 7 SelectEventbeforeF 7 SelectEvent){
```
```
if("kded_basedatafield".equals(beforeF 7 SelectEvent.getProperty().getName())){
ListShowParameterlistShowParameter=(ListShowParameter)
```
```
beforeF 7 SelectEvent.getFormShowParameter();
listShowParameter.setShowApproved(false);
DynamicObjectbaseData=(DynamicObject)
this.getModel().getValue("kded_basedatafield");
if(baseData!=null){
//设置单个已选
listShowParameter.setSelectedRow(baseData.getPkValue());
listShowParameter.setSelectedRows(new
Object[]{baseData.getPkValue()});//设置多个已选
listShowParameter.setMultiSelect(true);//开启多选
}
｝
```
## 三、后端数据操作..........................................................................................................................

### 1 .如何新建数据对象并赋值.................................................................................................

#### ( 1 )新建空数据对象.......................................................................................................

可以使用DynamicObject的构造函数，也可以使用BusinessDataServiceHelper或ORM
提供的接口。
方式 1 ：
DynamicObjectdata
=BusinessDataServiceHelper.newDynamicObject("kded_simplebill");


###### 方式 2 ：

```
DynamicObjectkded_simplebill=
ORM.create().newDynamicObject("kded_simplebill");
方式 3
MainEntityTypetype=
EntityMetadataCache.getDataEntityType("kded_simplebill");
DynamicObjectdata 1 =newDynamicObject((DynamicObjectType)type);
```
#### ( 2 )给对象赋简单字段的值...........................................................................................

```
data.set("billno","测试 0002 ");
data.set("billstatus","A");
```
#### ( 3 )给对象新增单据体并赋值.......................................................................................

```
DynamicObjectCollectionentryentity=
data.getDynamicObjectCollection("entryentity");
//新增单据体方式一：
DynamicObjectdynamicObject=entryentity.addNew();
dynamicObject.set("kded_textfield","代码新增单据体方式 1 ");
```
###### //新增单据体方式二：

```
DynamicObjectdynamicObject 1 =
newDynamicObject(entryentity.getDynamicObjectType());
dynamicObject 1 .set("kded_textfield","代码新增单据体方式 2 ");
entryentity.add(dynamicObject 1 );
```
#### ( 4 )给对象新增子单据体并赋值...................................................................................

```
DynamicObjectCollectionentryentity=data.getDynamicObjectCollection("entryentity
");
DynamicObject entry = new DynamicObject(entryentity.getDynamicObjectType());
entry.set("kdec_textfield","hello 1 ");
entry.set("kdec_integerfield", 95271 );
entryentity.add(entry);
```

###### //单据体数据

```
DynamicObjectCollectionsubentryentity=entry.getDynamicObjectCollection("subent
ryentity");
//单据体的子单据体
DynamicObjectsubentry=newDynamicObject(subentryentity.getDynamicObjectType
());
subentry.set("kdec_textfield 1 ","world");
subentry.set("kdec_integerfield 1 ", 12138 );subentryentity.add(subentry);
```
### 2 .如何保存数据对象.............................................................................................................

### ( 1 )SaveServiceHelper.........................................................................................................

###### //方式 1 - 走保存操作的校验

```
OperationResultoperationResult 1 =
SaveServiceHelper.saveOperate("kded_simplebill",newDynamicObject[]{data},
OperateOption.create());
//方式 2 - 直接存库
SaveServiceHelper.save(newDynamicObject[]{data});
```
### ( 2 )OperationServiceHelper..............................................................................................

###### 该接口可以执行单据的操作，如执行提交操作：

```
OperationResultoperationResult=
OperationServiceHelper.executeOperate("submit","kded_simplebill",new
DynamicObject[]{data},OperateOption.create());
if(!operationResult.getSuccessPkIds().isEmpty()){
//执行成功
}
```

### 3 .如何查询数据对象.............................................................................................................

#### ( 1 )查询简单字段&使用简单字段做过滤条件...........................................................

```
//方式 1 - 根据单据id查询-可以查询所有字段
ObjectbillId=" 1515996182680175616 ";
DynamicObjectsimpleBill=BusinessDataServiceHelper.loadSingle(billId,
"kded_simplebill");
//方式 2 - 根据单据id查询-查询指定字段，查询结果是平铺的
QFilterfilter=newQFilter("id",QCP.equals,billId);
DynamicObjectsimpleBillObject=
QueryServiceHelper.queryOne("kded_simplebill", "id,billno,createtime", new
QFilter[]{filter});
```
#### ( 2 )查询复杂字段&使用复杂字段做过滤条件...........................................................

```
//方式 1 - 根据创建人的名称构造过滤条件-BusinessDataServiceHelper
QFilterfilter 2 =newQFilter("creator.name",QCP.equals,"XXX");
DynamicObjectsimpleBill 2 =
BusinessDataServiceHelper.loadSingle("kded_simplebill","id,billno,creator,creato
r.id,createtime",newQFilter[]{filter 2 });
DynamicObjectcreator=simpleBill 2 .getDynamicObject("creator");
longcreatorId=simpleBill 2 .getLong("creator.id");
//方式 2 - 根据创建人的名称构造过滤条件-QueryServiceHelper
DynamicObjectsimpleBillObject 3 =
QueryServiceHelper.queryOne("kded_simplebill",
"id,billno,creator,creator.id,createtime",newQFilter[]{filter 2 });
DynamicObjectcreator 1 =simpleBill 2 .getDynamicObject("creator");
```

#### ( 3 )查询单据体字段&使用单据体字段做过滤条件...................................................

##### ①使用BusinessDataServiceHelper.................................................................

###### //根据单据体的字段构造过滤条件

QFilterfilter 3 =newQFilter("entryentity.kded_dealuser.name",QCP.equals,"金
小
蝶");
DynamicObjectsimpleBill 3 =
BusinessDataServiceHelper.loadSingle("kded_simplebill","id,billno,kded_dealuse
r,kded_dealdesc",newQFilter[]{filter 3 });
DynamicObjectCollectioncols=
simpleBill 3 .getDynamicObjectCollection("entryentity");
for(DynamicObjectcol:cols){
DynamicObjectuser=col.getDynamicObject("kded_dealuser");
Stringname=user.getString("name");
Stringdec=col.getString("kded_dealdesc");
}
注意点：
1 .过滤条件使用单据体字段做过滤条件需要加上单据体标识，如
entryentity.kded_dealuser.name；
2 .查询字段selectfields查询单据体字段可不用加单据体标识，如
DynamicObjectuser=col.getDynamicObject("kded_dealuser");
3 .user默认有id，number、name字段，如需其他字段，需要单据给该基础资料字段配置
引用属性。

##### ②使用BusinessDataServiceHelper.................................................................

```
QFilterfilter 5 =newQFilter("entryentity.kded_dealuser.name",QCP.equals,"金小
蝶");
DynamicObjectCollectionsimpleBills=
QueryServiceHelper.query("kded_simplebill","id,billno,entryentity.kded_dealuser.
name,entryentity.kded_dealdesc",newQFilter[]{filter 5 });
for(DynamicObjectdynamicObject:simpleBills){
```

dynamicObject.get("entryentity.kded_dealuser.name");
}
注意点：过滤条件和查询字段使用单据体字段都需要用单据体标识entryentity， 指定什
么字段则查出什么字段。

#### ( 4 )查询子单据体字段&使用单据体字段做过滤条件...............................................

###### //根据单据体的字段构造过滤条件查询子单据体字段

QFilterfilter 4 =newQFilter("entryentity.kded_dealuser.name",QCP.equals,"金
小蝶 ");
DynamicObjectsimpleBill 4 =
BusinessDataServiceHelper.loadSingle("kded_simplebill","id,billno,kded_dealuser,
kded_dealdesc,kded_subdealuser,kded_subdec",newQFilter[]{filter 4 });
DynamicObjectCollectioncols 1 =
simpleBill 4 .getDynamicObjectCollection("entryentity");
for(DynamicObjectcol:cols 1 ){
//获取单据体字段
DynamicObjectuser=col.getDynamicObject("kded_dealuser");
Stringname=user.getString("name");
Stringdec=col.getString("kded_dealdesc");
DynamicObjectCollectionsubCols=
col.getDynamicObjectCollection("kded_subentryentity");
for(DynamicObjectsubCol:subCols){
//获取子单据体字段
DynamicObjectsubDealUser=
subCol.getDynamicObject("kded_subdealuser");
StringsubDec=subCol.getString("kded_subdec");
}
}


### 4 .如何删除数据对象.............................................................................................................

#### （ 1 ）直接从数据库删除数据，不触发数据校验.......................................................

```
DynamicObjectdObj=null;
//IDataEntityType为实体类型基类
IDataEntityTypedataEntityType=dObj.getDataEntityType();
//pks为数据主键值
DeleteServiceHelper.delete(IDataEntityTypetype,Object[]pks)
```
#### （ 2 ）删除数据时，触发数据校验................................................................................

```
DeleteServiceHelperdeleteServiceHelper=newDeleteServiceHelper();
deleteServiceHelper.deleteOperate("删除的操作代码","单据标识",pks,
OperateOption.create());
//或者直接调用通用操作接口
OperationServiceHelper.executeOperate("删除的操作代码","单据标识",pks,
OperateOption.create())
```
## 四、操作...........................................................................................................................................

### 1 .代码触发操作.....................................................................................................................

#### ( 1 )界面插件触发操作...................................................................................................

界面模型View提供了触发操作的接口。
this.getView().invokeOperation("submit");


#### ( 2 )非界面插件触发操作...............................................................................................

非界面插件没有界面模型View，需要通过操作服务工具类触发（也可以界面插件使用）。
OperationResultoperationResult=
OperationServiceHelper.executeOperate("submit","kded_simplebill",new
DynamicObject[]{data},OperateOption.create());
if(!operationResult.getSuccessPkIds().isEmpty()){
//todo;
}

#### ( 3 )代码触发操作如何忽略验权...................................................................................

通过OperateOption传递对应参数，可以绕过权限校验。
OperateOptionoption=OperateOption.create();
option.setVariableValue(OperateOptionConst.ISHASRIGHT,"true");OperationResult

### 2 .操作后如何刷新字段.........................................................................................................

#### ( 1 )配置实现...................................................................................................................

###### 单据状态、日期这两种类型的字段可以在操作配置刷新字段实现。


#### ( 2 )代码实现...................................................................................................................

```
@Override
publicvoidafterDoOperation(AfterDoOperationEventArgs
afterDoOperationEventArgs){
super.afterDoOperation(afterDoOperationEventArgs);
FormOperateformoperate=(FormOperate)
afterDoOperationEventArgs.getSource();
if("操作代码".equals(formoperate.getOperateKey())){
if(!afterDoOperationEventArgs.getOperationResult().getSuccessPkIds().
isEmpty()){
this.getView().updateView("字段标识");
}
}
```

### 3 .操作后如何提示.................................................................................................................

#### ( 1 )配置提示...................................................................................................................

###### 固定的提示语可以直接在操作进行配置，如图：

#### ( 2 )代码修改操作后的提示...........................................................................................

###### 首先得在操作配置操作成功后提示，通过代码修改提示内容才会弹出显示。

###### 方式 1 ：在操作插件实现。

```
@Override
publicvoidafterExecuteOperationTransaction(AfterOperationArgse){
if("save".equals(e.getOperationKey())&&!this.getOperationResult().getSuccessPkI
ds().isEmpty()){
```

this.getOperationResult().setMessage("保存成功啦-操作插件");
}
}
方式 2 ：在界面插件实现。
@Override
publicvoidafterDoOperation(AfterDoOperationEventArgs
afterDoOperationEventArgs){
super.afterDoOperation(afterDoOperationEventArgs);
FormOperateformoperate=(FormOperate)
afterDoOperationEventArgs.getSource();
if("save".equals(formoperate.getOperateKey())&&!afterDoOperationEventA
rgs.getOperationResult().getSuccessPkIds().isEmpty()){
afterDoOperationEventArgs.getOperationResult().setMessage("保存成
功！-界面插件");
}
}

### 4 .操作插件跟界面插件如何传递参数.................................................................................

##### ( 1 )从界面传递参数给操作插件...........................................................................

###### 首先在界面插件给操作塞参数

@Override
publicvoidbeforeDoOperation(BeforeDoOperationEventArgsargs){
super.beforeDoOperation(args);
FormOperateformoperate=(FormOperate)args.getSource();
if("save".equals(formoperate.getOperateKey())){
formoperate.getOption().setVariableValue("customItem",this.getView().
getPageCache().get("customItem"));
}
}
然后在操作插件取参数：
@Override
publicvoidbeginOperationTransaction(BeginOperationTransactionArgse){
super.beginOperationTransaction(e);


```
if("save".equals(e.getOperationKey())){
//取出界面传过来的参数
StringcustomItem=this.getOption().getVariableValue("customItem");
}
}
```
##### ( 2 )从操作插件传递参数给界面...........................................................................

首先在操作插件给操作Option塞参数
@Override
publicvoidafterExecuteOperationTransaction(AfterOperationArgse){
if("save".equals(e.getOperationKey())&&!this.getOperationResult().getSuccessPkI
ds().isEmpty()){
this.getOption().setVariableValue("allBillNo","");
}
}
然后在界面插件取参数
@Override
publicvoidafterDoOperation(AfterDoOperationEventArgs
afterDoOperationEventArgs){
super.afterDoOperation(afterDoOperationEventArgs);
FormOperateformoperate=(FormOperate)
afterDoOperationEventArgs.getSource();
if("save".equals(formoperate.getOperateKey())&&!afterDoOperationEventA
rgs.g etOperationResult().getSuccessPkIds().isEmpty()){
String allBillNo =
formoperate.getOption().getVariableValue("allBillNo");
}
}